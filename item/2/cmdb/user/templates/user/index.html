{% load static %}


<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <link rel="icon" href="{%static 'user:favicon.ico' %}">
    <title>用户显示</title>

    <link href="{% static 'bootstrap-3.3.7-dist/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'sweetalert-1.0.1/dist/sweetalert.css' %}" rel="stylesheet">
    <link href="{% static 'DataTables-1.10.15/media/css/dataTables.bootstrap.min.css' %}" rel="stylesheet" />
    <link href="{% static 'DataTables-1.10.15/media/css/jquery.dataTables.min.css' %}" rel="stylesheet" />

    <style type="text/css">
        body {
          padding-top: 70px;
        }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">CMDB</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">用户管理</a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a>当前登录用户是:{{ request.session.user.name }}</a></li>
            <li class="active"><a href="{% url 'user:logout' %}">退出登录</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
        <a class="btn btn-primary btn-create-user" href="javascript:void(0);">创建用户</a>
        <br/>
        <br/> 
        <table id="table_user" class="table table-striped table-bordered table-hover table-condensed" >
            <thead>
                <tr>
                    <th>姓名</th>
                    <th>年龄</th>
                    <th>性别</th>
                    <th>联系方式</th>
                    <th>操作1</th>
                    <th>操作2</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                    <tr>
                        <td>{{ user.name }}</td>
                        <td>{{ user.age }}</td>
                        <td>
                            {% if user.sex == 0 %}
                            女
                            {% else %}
                            男
                            {% endif %}
                        </td>
                        <td>{{ user.tel }}</td>
                        <td>
                            <a class="btn btn-xs btn-success" href="{% url 'user:view' %}?uid={{ user.id }}">编辑</a> 
                            {% if request.session.user.id != user.id %}
                            <a class="btn btn-xs btn-danger" href="{% url 'user:delete' %}?uid={{ user.id }}">删除</a> 
                            {% endif %}
                        </td>
                        <td>
                            {% if request.session.user.id == user.id %}
                            <a class="btn btn-xs btn-success" href="{% url 'user:changepass_view' %}?uid={{ user.id }}">修改密码</a> 
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="dialog-user-create" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">新建用户</h4>
          </div>
          <div class="modal-body">
            
            <form class="form-horizontal form-create-user" method="POST">
                  {% csrf_token %}
                  <div class="form-group"> 
                    <label class="control-label col-md-3">用户名: </label>
                    <div class="col-md-7">
                     <input type="text" class="form-control" name="name" value="" />
                    </div>
                  </div>

                  <div class="form-group"> 
                    <label class="control-label col-md-3">密码: </label>
                      <div class="col-md-7">
                      <input type="password" class="form-control" name="password" value=""  />
                      </div>
                  </div>

                  <div class="form-group"> 
                    <label class="control-label col-md-3">再次输入密码: </label>
                    <div class="col-md-7">                  
                      <input type="password" class="form-control" name="password_new" value=""  />
                    </div>
                  </div>

                  <div class="form-group"> 
                    <label class="control-label col-md-3">年龄: </label>
                    <div class="col-md-7">    
                      <input type="text" class="form-control"  name="age" value="" />
                    </div>
                  </div>

                  <div class="form-group"> 
                    <label class="control-label col-md-3">联系方式: </label>
                    <div class="col-md-7">   
                      <input type="text" class="form-control" name="tel"  value=""  />
                    </div>
                  </div>

                  <div class="form-group"> 
                    <label class="control-label col-md-3">性别: </label>
                    <div class="col-md-7">  
                      <label class="radio-inline">
                        <input type="radio" name="sex" value="1" checked="checked" />男
                      </label>

                      <label class="radio-inline">
                        <input type="radio" name="sex" value="0" />女
                      </label>
                    </div>
                  </div>

             </form>

          </div>
          <div class="modal-footer">
            <a class="btn btn-default" data-dismiss="modal">关闭</a>
            <a class="btn btn-primary btn-save-user">保存</a>
          </div>
        </div>
      </div>
    </div>

    <script  src="{% static 'jquery/jquery.min.js' %}"></script>
    <script  src="{% static 'bootstrap-3.3.7-dist/js/bootstrap.min.js' %}"></script>
    <script  src="{% static 'sweetalert-1.0.1/dist/sweetalert.min.js' %}"></script>
    
    <script  src="{% static 'DataTables-1.10.15/media/js/jquery.dataTables.min.js' %}"></script>
    <script  src="{% static 'DataTables-1.10.15/media/js/dataTables.bootstrap.min.js' %}"></script>


    <script type="text/javascript">
    jQuery(document).ready(function() {
      jQuery('#table_user').DataTable({
          "language": {
              "processing": "处理中...",
              "lengthMenu": "显示 _MENU_ 项结果",
              "zeroRecords": "没有匹配结果",
              "info": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
              "infoEmpty": "显示第 0 至 0 项结果，共 0 项",
              "infoFiltered": "(由 _MAX_ 项结果过滤)",
              "infoPostFix": "",
              "search": "搜索:",
              "searchPlaceholder": "搜索...",
              "url": "",
              "emptyTable": "表中数据为空",
              "loadingRecords": "载入中...",
              "infoThousands": ",",
              "paginate": {
                "first": "首页",
                "previous": "上页",
                "next": "下页",
                "last": "末页"
              },
              "aria": {
                paginate: {
                    first: '首页',
                    previous: '上页',
                    next: '下页',
                    last: '末页'
                },
                "sortAscending": ": 以升序排列此列",
                "sortDescending": ": 以降序排列此列"
              },
              "decimal": "-",
              "thousands": "."
              }
            
      });

      jQuery('.btn-create-user').on('click', function(){
          jQuery('#dialog-user-create').modal({
                show: true,
                backdrop: false,
                keyboard: false
          });
      });
      
      jQuery('.btn-save-user').on('click', function() {
          var data = jQuery('.form-create-user').serializeArray()
          
          jQuery.post("{% url 'user:create_ajax' %}", data, function(result)
            {
            console.log(result);
            if(result['code'] == 200){
              swal("成功", "", "success")
              jQuery('#dialog-user-create').modal('hide');
              window.location.reload()
            } else if(result['code'] == 400){
              var errors = []
              jQuery.each(result['errors'], function(k, v){
                errors.push(v)
              });
              swal("验证失败:", errors.join('\n'), "error");
            } else if(result['code'] == 403){
              swal({
                  title: "未登录",
                  text: "",
                  timer: 2000,
                  showConfirmButton: false
              });
            }

          }, 'json')

      });

    });
     </script>
  </body>
</html>
